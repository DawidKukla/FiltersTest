var TestTree;
(function (TestTree) {
    var MockServiceModule;
    (function (MockServiceModule) {
        var TestNodeHelper = TestTree.Common.MemberNodesHelper;
        var MemberFilterType = TestTree.Common.MemberFilterType;
        var MetadataResponse = TestTree.Common.MetadataResponse;
        var FilterMetadata = TestTree.Common.FilterMetadata;
        var FilterLevel = TestTree.Common.FilterLevel;
        class MockService {
            constructor(_testTree, _connectionString, _hierarchyUniqueName) {
                this._testTree = _testTree;
                this._connectionString = _connectionString;
                this._hierarchyUniqueName = _hierarchyUniqueName;
                this._totalElementsCount = 0;
                this._testSortedLevels = [new FilterLevel("Year", "Year"), new FilterLevel("Quater", "Quater"), new FilterLevel("Month", "Month"), new FilterLevel("Day", "Day")];
                this.CreateIds(_testTree);
                this.AddParentUniqueNames_Levels_ChildCount_AndCalculateTotalElementsCount(_testTree);
            }
            GetLevelNumberFromUniqueName(uniqueName) {
                return this._testSortedLevels.map(x => x.UniqueName).indexOf(uniqueName);
            }
            async GetMetadata(request) {
                var metadata = new FilterMetadata(request.FieldUniqueName, "Calendar Time", this._testSortedLevels, this._testTree.length, this._totalElementsCount);
                return new MetadataResponse(metadata, []);
            }
            async GetMembers(request) {
                var result = this.GetMembersCore(this.GetLevelNumberFromUniqueName(request.FieldUniqueName), request.Start, request.Count, request.Filter, false);
                return { FilterInfo: result };
            }
            async GetLeafMembers(request) {
                var result = this.GetMembersCore(this.GetLevelNumberFromUniqueName(request.FieldUniqueName), request.Start, request.Count, request.Filter, true);
                return { FilterInfo: result };
            }
            async GetChildren(request) {
                var result = null;
                var temp = this.GetCopyOfWorkingTree();
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(temp, (x) => x.children, (x) => {
                    if (x.id === request.Parent) {
                        result = x;
                        return false;
                    }
                    return true;
                });
                result = this.SelectSpecyficElements(this.MakeLazyLoaded(result.children), request.Start, request.Count + 1);
                var hasMoreNodes = this.HasMoreMembers(request.Count, result);
                if (hasMoreNodes) {
                    result.pop();
                }
                result = this.ClearNotNeededData(result, {}, hasMoreNodes);
                return { FilterInfo: result };
            }
            GetCopyOfWorkingTree() {
                return this.GetCopyOfTree(this._testTree);
            }
            GetCopyOfTree(tree) {
                return JSON.parse(JSON.stringify(tree));
            }
            MakeLazyLoaded(nodes) {
                nodes.forEach(node => {
                    if (node.children.length) {
                        node.children = true;
                        delete node.state;
                    }
                });
                return nodes;
            }
            SelectSpecyficElements(nodes, startIndex, numberOfElements) {
                var result = [];
                for (var i = startIndex; i < nodes.length && result.length <= numberOfElements - 1; i++) {
                    result.push(nodes[i]);
                }
                return result;
            }
            GetMembersCore(targetLevelNumber, start, count, filter, onlyLeafs = false) {
                var temp = this.GetCopyOfWorkingTree();
                temp = this.SearchMembersCore(temp, targetLevelNumber, filter);
                var allParentsLookup = {};
                var targetLevelElementsList = [];
                var targetParentsLookup = {};
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(temp, (x) => x.children, (x, parent, level, index) => {
                    if (onlyLeafs) {
                        if (x.data && x.data.childrenTotalCount === 0) {
                            targetLevelElementsList.push(x);
                        }
                    }
                    else if (x.data && x.data.level === targetLevelNumber) {
                        if (x.children.length) {
                            x.children = true;
                        }
                        targetLevelElementsList.push(x);
                    }
                    if (parent) {
                        allParentsLookup[parent.id] = parent;
                    }
                    return true;
                }, new Comarch.Utils.TreeUtils.ForwardTreeTraversalIteratorFactory());
                for (let key in allParentsLookup) {
                    if (allParentsLookup.hasOwnProperty(key)) {
                        allParentsLookup[key].children.length = 0;
                    }
                }
                temp = this.SelectSpecyficElements(targetLevelElementsList, start, count + 1);
                var hasMoreMembers = this.HasMoreMembers(count, temp);
                if (hasMoreMembers) {
                    temp.pop();
                }
                temp.forEach(x => {
                    TestNodeHelper.GetAllParentsNames(allParentsLookup, x).forEach(parentName => {
                        targetParentsLookup[parentName] = true;
                    });
                });
                for (let key in allParentsLookup) {
                    if (!targetParentsLookup[key]) {
                        delete allParentsLookup[key];
                    }
                }
                return this.ClearNotNeededData(temp, allParentsLookup, hasMoreMembers);
            }
            ClearNotNeededData(lastLevelNodes, allParentsLookup, hasMoreMembers) {
                lastLevelNodes.forEach(x => delete x.data.level);
                for (var parentKey in allParentsLookup) {
                    delete allParentsLookup[parentKey].data.level;
                }
                return { LastLevelNodes: lastLevelNodes, ParentsLookup: allParentsLookup, HasMoreMembers: hasMoreMembers };
            }
            SearchMembersCore(input, targetLevelNumber, filter) {
                if (!filter)
                    return input;
                var result = input;
                var matchFounded = false;
                var matchCounter = 0;
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(result, (x) => x.children, (x, parent, level, index) => {
                    if (level === targetLevelNumber) {
                        switch (filter.Type) {
                            case MemberFilterType.Contains:
                                matchFounded = x.text.toLowerCase().indexOf(filter.Value.toLowerCase()) !== -1;
                                break;
                            case MemberFilterType.BeginsWith:
                                matchFounded = x.text.toLowerCase().startsWith(filter.Value.toLowerCase());
                                break;
                            case MemberFilterType.EndsWith:
                                matchFounded = x.text.toLowerCase().endsWith(filter.Value.toLowerCase());
                                break;
                        }
                        if (!matchFounded) {
                            if (parent) {
                                parent.children.splice(index, 1);
                            }
                            else {
                                result.splice(index, 1);
                            }
                        }
                        else {
                            matchCounter++;
                        }
                    }
                    return true;
                });
                if (!matchCounter)
                    return [];
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(result, (x) => x.children, (x, parent, level, index) => {
                    if (level < targetLevelNumber && !x.children.length) {
                        if (parent) {
                            parent.children.splice(index, 1);
                            return false;
                        }
                        else {
                            result.splice(index, 1);
                            return false;
                        }
                    }
                    return true;
                });
                return result;
            }
            CreateIds(input) {
                var result = input;
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(result, (x) => x.children, (x, parent, level, index) => {
                    var parts = [];
                    var parentPart = "";
                    if (parent) {
                        parentPart = parent.id;
                        parts.push(parentPart);
                    }
                    parts.push(`[${x.text}]`);
                    x["id"] = parts.join(".");
                    return true;
                });
                return result;
            }
            AddParentUniqueNames_Levels_ChildCount_AndCalculateTotalElementsCount(input) {
                var result = input;
                Comarch.Utils.TreeUtils.TreeHelpers.TraverseListPreorder(result, (x) => x.children, (x, parent, level, index) => {
                    var parentUniqueName = null;
                    if (parent) {
                        parentUniqueName = parent.id;
                    }
                    x.data = {
                        parentUniqueName: parentUniqueName,
                        level: level,
                        childrenTotalCount: x.children.length
                    };
                    this._totalElementsCount++;
                    return true;
                }, new Comarch.Utils.TreeUtils.ForwardTreeTraversalIteratorFactory());
                return result;
            }
            static CreateFakeTimeHierarchy(numberOfYears) {
                var result = [];
                var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                for (var y = 0; y < numberOfYears; y++) {
                    var yearItem = { text: (2000 + y).toString(), children: [] };
                    result.push(yearItem);
                    for (var q = 0; q < 4; q++) {
                        var quaterItem = { text: "Q" + (q + 1).toString(), children: [] };
                        yearItem.children.push(quaterItem);
                        for (var m = q * 3; m < q * 3 + 3; m++) {
                            var monthItem = { text: months[m], children: [] };
                            quaterItem.children.push(monthItem);
                            for (var d = 0; d < 30; d++) {
                                var dayItem = { text: (d + 1).toString(), children: [] };
                                monthItem.children.push(dayItem);
                            }
                        }
                    }
                }
                return result;
            }
            HasMoreMembers(count, loadedLastLevelNodes) {
                return loadedLastLevelNodes.length === count + 1;
            }
        }
        MockServiceModule.MockService = MockService;
    })(MockServiceModule = TestTree.MockServiceModule || (TestTree.MockServiceModule = {}));
})(TestTree || (TestTree = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW9ja1NlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJNb2NrU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFVLFFBQVEsQ0F3UmpCO0FBeFJELFdBQVUsUUFBUTtJQUFDLElBQUEsaUJBQWlCLENBd1JuQztJQXhSa0IsV0FBQSxpQkFBaUI7UUFHaEMsSUFBTyxjQUFjLEdBQUcsU0FBQSxNQUFNLENBQUMsaUJBQWlCLENBQUM7UUFFakQsSUFBTyxnQkFBZ0IsR0FBRyxTQUFBLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztRQUdsRCxJQUFPLGdCQUFnQixHQUFHLFNBQUEsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQ2xELElBQU8sY0FBYyxHQUFHLFNBQUEsTUFBTSxDQUFDLGNBQWMsQ0FBQztRQUM5QyxJQUFPLFdBQVcsR0FBRyxTQUFBLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFReEM7WUFJSSxZQUFvQixTQUF3QixFQUFTLGlCQUF3QixFQUFVLG9CQUEyQjtnQkFBOUYsY0FBUyxHQUFULFNBQVMsQ0FBZTtnQkFBUyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQU87Z0JBQVUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFPO2dCQUgxRyx3QkFBbUIsR0FBQyxDQUFDLENBQUM7Z0JBQ3RCLHNCQUFpQixHQUFlLENBQUMsSUFBSSxXQUFXLENBQUMsTUFBTSxFQUFDLE1BQU0sQ0FBQyxFQUFDLElBQUksV0FBVyxDQUFDLFFBQVEsRUFBQyxRQUFRLENBQUMsRUFBQyxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUMsT0FBTyxDQUFDLEVBQUMsSUFBSSxXQUFXLENBQUMsS0FBSyxFQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBR3RLLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxxRUFBcUUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMxRixDQUFDO1lBRVEsNEJBQTRCLENBQUMsVUFBaUI7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LENBQUMsR0FBQyxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7NEJBQy9CLElBQUksU0FBUyxHQUFnQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDOzRCQUMvRCxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs0QkFDcEMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQ0FDMUIsSUFBSSxPQUFPLEdBQWdCLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQztnQ0FDcEUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7NEJBQ3JDLENBQUM7d0JBQ0wsQ0FBQztvQkFDTCxDQUFDO2dCQUNMLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUNsQixDQUFDO1lBRU8sY0FBYyxDQUFDLEtBQWEsRUFBRSxvQkFBa0M7Z0JBQ3BFLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssS0FBSyxHQUFDLENBQUMsQ0FBQztZQUNuRCxDQUFDO1NBRUo7UUFwUVksNkJBQVcsY0FvUXZCLENBQUE7SUFFTCxDQUFDLEVBeFJrQixpQkFBaUIsR0FBakIsMEJBQWlCLEtBQWpCLDBCQUFpQixRQXdSbkM7QUFBRCxDQUFDLEVBeFJTLFFBQVEsS0FBUixRQUFRLFFBd1JqQiIsInNvdXJjZXNDb250ZW50IjpbIm5hbWVzcGFjZSBUZXN0VHJlZS5Nb2NrU2VydmljZU1vZHVsZSB7XHJcbiAgICBpbXBvcnQgSU1lbWJlck5vZGUgPSBDb21tb24uSU1lbWJlck5vZGU7XHJcbiAgICBpbXBvcnQgSU1lbWJlck5vZGVMb29rdXAgPSBDb21tb24uSU1lbWJlck5vZGVMb29rdXA7XHJcbiAgICBpbXBvcnQgVGVzdE5vZGVIZWxwZXIgPSBDb21tb24uTWVtYmVyTm9kZXNIZWxwZXI7XHJcbiAgICBpbXBvcnQgTWVtYmVyRmlsdGVyID0gQ29tbW9uLk1lbWJlckZpbHRlcjtcclxuICAgIGltcG9ydCBNZW1iZXJGaWx0ZXJUeXBlID0gQ29tbW9uLk1lbWJlckZpbHRlclR5cGU7XHJcbiAgICBpbXBvcnQgTWV0YWRhdGFSZXF1ZXN0ID0gQ29tbW9uLk1ldGFkYXRhUmVxdWVzdDtcclxuICAgIGltcG9ydCBJRmlsdGVySW5mbyA9IENvbW1vbi5JRmlsdGVySW5mbztcclxuICAgIGltcG9ydCBNZXRhZGF0YVJlc3BvbnNlID0gQ29tbW9uLk1ldGFkYXRhUmVzcG9uc2U7XHJcbiAgICBpbXBvcnQgRmlsdGVyTWV0YWRhdGEgPSBDb21tb24uRmlsdGVyTWV0YWRhdGE7XHJcbiAgICBpbXBvcnQgRmlsdGVyTGV2ZWwgPSBDb21tb24uRmlsdGVyTGV2ZWw7XHJcbiAgICBpbXBvcnQgTWVtYmVyc1JlcXVlc3QgPSBDb21tb24uTWVtYmVyc1JlcXVlc3Q7XHJcbiAgICBpbXBvcnQgTWVtYmVyc1Jlc3BvbnNlID0gQ29tbW9uLk1lbWJlcnNSZXNwb25zZTtcclxuICAgIGltcG9ydCBMZWFmTWVtYmVyc1JlcXVlc3QgPSBDb21tb24uTGVhZk1lbWJlcnNSZXF1ZXN0O1xyXG4gICAgaW1wb3J0IENoaWxkcmVuUmVxdWVzdCA9IENvbW1vbi5DaGlsZHJlblJlcXVlc3Q7XHJcbiAgICBpbXBvcnQgSUZpbHRlckNvbnRyb2xTZXJ2aWNlID0gQ29tbW9uLklGaWx0ZXJDb250cm9sU2VydmljZTtcclxuXHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIE1vY2tTZXJ2aWNlIGltcGxlbWVudHMgSUZpbHRlckNvbnRyb2xTZXJ2aWNlIHtcclxuICAgICAgICBwcml2YXRlIF90b3RhbEVsZW1lbnRzQ291bnQ9MDtcclxuICAgICAgICBwcml2YXRlIF90ZXN0U29ydGVkTGV2ZWxzOkZpbHRlckxldmVsW109W25ldyBGaWx0ZXJMZXZlbChcIlllYXJcIixcIlllYXJcIiksbmV3IEZpbHRlckxldmVsKFwiUXVhdGVyXCIsXCJRdWF0ZXJcIiksbmV3IEZpbHRlckxldmVsKFwiTW9udGhcIixcIk1vbnRoXCIpLG5ldyBGaWx0ZXJMZXZlbChcIkRheVwiLFwiRGF5XCIpXTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBfdGVzdFRyZWU6IElNZW1iZXJOb2RlW10scHJpdmF0ZSBfY29ubmVjdGlvblN0cmluZzpzdHJpbmcscHJpdmF0ZSAgX2hpZXJhcmNoeVVuaXF1ZU5hbWU6c3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuQ3JlYXRlSWRzKF90ZXN0VHJlZSk7XHJcbiAgICAgICAgICAgIHRoaXMuQWRkUGFyZW50VW5pcXVlTmFtZXNfTGV2ZWxzX0NoaWxkQ291bnRfQW5kQ2FsY3VsYXRlVG90YWxFbGVtZW50c0NvdW50KF90ZXN0VHJlZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlICBHZXRMZXZlbE51bWJlckZyb21VbmlxdWVOYW1lKHVuaXF1ZU5hbWU6c3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXN0U29ydGVkTGV2ZWxzLm1hcCh4PT54LlVuaXF1ZU5hbWUpLmluZGV4T2YodW5pcXVlTmFtZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgYXN5bmMgR2V0TWV0YWRhdGEocmVxdWVzdDogTWV0YWRhdGFSZXF1ZXN0KTogUHJvbWlzZTxNZXRhZGF0YVJlc3BvbnNlPiB7XHJcbiAgICAgICAgICAgIHZhciBtZXRhZGF0YSA9IG5ldyBGaWx0ZXJNZXRhZGF0YShyZXF1ZXN0LkZpZWxkVW5pcXVlTmFtZSwgXCJDYWxlbmRhciBUaW1lXCIsIHRoaXMuX3Rlc3RTb3J0ZWRMZXZlbHMsIHRoaXMuX3Rlc3RUcmVlLmxlbmd0aCwgdGhpcy5fdG90YWxFbGVtZW50c0NvdW50KTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBNZXRhZGF0YVJlc3BvbnNlKG1ldGFkYXRhLCBbXSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgYXN5bmMgR2V0TWVtYmVycyhyZXF1ZXN0OiBNZW1iZXJzUmVxdWVzdCk6IFByb21pc2U8TWVtYmVyc1Jlc3BvbnNlPiB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSB0aGlzLkdldE1lbWJlcnNDb3JlKHRoaXMuR2V0TGV2ZWxOdW1iZXJGcm9tVW5pcXVlTmFtZShyZXF1ZXN0LkZpZWxkVW5pcXVlTmFtZSksIHJlcXVlc3QuU3RhcnQsIHJlcXVlc3QuQ291bnQsIHJlcXVlc3QuRmlsdGVyLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IEZpbHRlckluZm86IHJlc3VsdCB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIGFzeW5jIEdldExlYWZNZW1iZXJzKHJlcXVlc3Q6IExlYWZNZW1iZXJzUmVxdWVzdCk6IFByb21pc2U8TWVtYmVyc1Jlc3BvbnNlPiB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSB0aGlzLkdldE1lbWJlcnNDb3JlKHRoaXMuR2V0TGV2ZWxOdW1iZXJGcm9tVW5pcXVlTmFtZShyZXF1ZXN0LkZpZWxkVW5pcXVlTmFtZSksIHJlcXVlc3QuU3RhcnQsIHJlcXVlc3QuQ291bnQsIHJlcXVlc3QuRmlsdGVyLCB0cnVlKTtcclxuICAgICAgICAgICAgcmV0dXJuIHsgRmlsdGVySW5mbzogcmVzdWx0IH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhc3luYyBHZXRDaGlsZHJlbihyZXF1ZXN0OiBDaGlsZHJlblJlcXVlc3QpOiBQcm9taXNlPE1lbWJlcnNSZXNwb25zZT4ge1xyXG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gbnVsbDtcclxuICAgICAgICAgICAgdmFyIHRlbXAgPSB0aGlzLkdldENvcHlPZldvcmtpbmdUcmVlKCk7XHJcbiAgICAgICAgICAgIENvbWFyY2guVXRpbHMuVHJlZVV0aWxzLlRyZWVIZWxwZXJzLlRyYXZlcnNlTGlzdFByZW9yZGVyPElNZW1iZXJOb2RlPih0ZW1wLFxyXG4gICAgICAgICAgICAgICAgKHgpID0+IHguY2hpbGRyZW4gYXMgSU1lbWJlck5vZGVbXSxcclxuICAgICAgICAgICAgICAgICh4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHguaWQgPT09IHJlcXVlc3QuUGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5TZWxlY3RTcGVjeWZpY0VsZW1lbnRzKHRoaXMuTWFrZUxhenlMb2FkZWQocmVzdWx0LmNoaWxkcmVuKSwgcmVxdWVzdC5TdGFydCwgcmVxdWVzdC5Db3VudCsxKTtcclxuICAgICAgICAgICAgdmFyIGhhc01vcmVOb2RlcyA9IHRoaXMuSGFzTW9yZU1lbWJlcnMocmVxdWVzdC5Db3VudCwgcmVzdWx0KTtcclxuICAgICAgICAgICAgaWYgKGhhc01vcmVOb2Rlcykge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnBvcCgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXN1bHQgPSB0aGlzLkNsZWFyTm90TmVlZGVkRGF0YShyZXN1bHQsIHt9LCBoYXNNb3JlTm9kZXMpO1xyXG4gICAgICAgICAgICByZXR1cm4geyBGaWx0ZXJJbmZvOiByZXN1bHQgfTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIEdldENvcHlPZldvcmtpbmdUcmVlKCk6SU1lbWJlck5vZGVbXSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLkdldENvcHlPZlRyZWUodGhpcy5fdGVzdFRyZWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBwcml2YXRlIEdldENvcHlPZlRyZWUodHJlZTpJTWVtYmVyTm9kZVtdKTpJTWVtYmVyTm9kZVtdIHtcclxuICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodHJlZSkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBNYWtlTGF6eUxvYWRlZChub2RlczogSU1lbWJlck5vZGVbXSkge1xyXG4gICAgICAgICAgICBub2Rlcy5mb3JFYWNoKG5vZGUgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5jaGlsZHJlbiA9IDxhbnk+dHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgbm9kZS5zdGF0ZTtcclxuICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gbm9kZXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIFNlbGVjdFNwZWN5ZmljRWxlbWVudHMobm9kZXM6SU1lbWJlck5vZGVbXSxzdGFydEluZGV4OiBudW1iZXIsbnVtYmVyT2ZFbGVtZW50czpudW1iZXIpIHtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gc3RhcnRJbmRleDsgaSA8IG5vZGVzLmxlbmd0aCAmJiByZXN1bHQubGVuZ3RoPD1udW1iZXJPZkVsZW1lbnRzLTE7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobm9kZXNbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG5cclxuICAgICAgICBwcml2YXRlIEdldE1lbWJlcnNDb3JlKHRhcmdldExldmVsTnVtYmVyOiBudW1iZXIsc3RhcnQ6IG51bWJlcixjb3VudDpudW1iZXIsZmlsdGVyOk1lbWJlckZpbHRlciwgb25seUxlYWZzOmJvb2xlYW49ZmFsc2UpOiBJRmlsdGVySW5mbyB7XHJcbiAgICAgICAgICAgIHZhciB0ZW1wID0gdGhpcy5HZXRDb3B5T2ZXb3JraW5nVHJlZSgpO1xyXG4gICAgICAgICAgICB0ZW1wID0gdGhpcy5TZWFyY2hNZW1iZXJzQ29yZSh0ZW1wLCB0YXJnZXRMZXZlbE51bWJlciwgZmlsdGVyKTtcclxuICAgICAgICAgICAgdmFyIGFsbFBhcmVudHNMb29rdXA6SU1lbWJlck5vZGVMb29rdXAgPSB7fVxyXG4gICAgICAgICAgICB2YXIgdGFyZ2V0TGV2ZWxFbGVtZW50c0xpc3Q6IElNZW1iZXJOb2RlW10gPSBbXTtcclxuICAgICAgICAgICAgdmFyIHRhcmdldFBhcmVudHNMb29rdXA6IHtba2V5OnN0cmluZ106Ym9vbGVhbn0gPSB7fVxyXG4gICAgICAgICAgICBDb21hcmNoLlV0aWxzLlRyZWVVdGlscy5UcmVlSGVscGVycy5UcmF2ZXJzZUxpc3RQcmVvcmRlcjxJTWVtYmVyTm9kZT4odGVtcCxcclxuICAgICAgICAgICAgICAgICAgICAoeCkgPT4geC5jaGlsZHJlbiBhcyBJTWVtYmVyTm9kZVtdLCBcclxuICAgICAgICAgICAgICAgICAgICAoeCwgcGFyZW50LCBsZXZlbCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9ubHlMZWFmcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHguZGF0YSAmJiB4LmRhdGEuY2hpbGRyZW5Ub3RhbENvdW50PT09MCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldExldmVsRWxlbWVudHNMaXN0LnB1c2goeCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoeC5kYXRhICYmIHguZGF0YS5sZXZlbCA9PT0gdGFyZ2V0TGV2ZWxOdW1iZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4LmNoaWxkcmVuLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHguY2hpbGRyZW4gPSA8YW55PnRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRMZXZlbEVsZW1lbnRzTGlzdC5wdXNoKHgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxQYXJlbnRzTG9va3VwW3BhcmVudC5pZF0gPSBwYXJlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgbmV3IENvbWFyY2guVXRpbHMuVHJlZVV0aWxzLkZvcndhcmRUcmVlVHJhdmVyc2FsSXRlcmF0b3JGYWN0b3J5KClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGFsbFBhcmVudHNMb29rdXApIHtcclxuICAgICAgICAgICAgICAgIGlmIChhbGxQYXJlbnRzTG9va3VwLmhhc093blByb3BlcnR5KGtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbGxQYXJlbnRzTG9va3VwW2tleV0uY2hpbGRyZW4ubGVuZ3RoID0gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0ZW1wID0gdGhpcy5TZWxlY3RTcGVjeWZpY0VsZW1lbnRzKHRhcmdldExldmVsRWxlbWVudHNMaXN0LHN0YXJ0LGNvdW50KzEpO1xyXG4gICAgICAgICAgICB2YXIgaGFzTW9yZU1lbWJlcnMgPSB0aGlzLkhhc01vcmVNZW1iZXJzKGNvdW50LCB0ZW1wKTtcclxuICAgICAgICAgICAgaWYgKGhhc01vcmVNZW1iZXJzKSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wLnBvcCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRlbXAuZm9yRWFjaCh4ID0+IHtcclxuICAgICAgICAgICAgICAgIFRlc3ROb2RlSGVscGVyLkdldEFsbFBhcmVudHNOYW1lcyhhbGxQYXJlbnRzTG9va3VwLCB4KS5mb3JFYWNoKHBhcmVudE5hbWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFBhcmVudHNMb29rdXBbcGFyZW50TmFtZV0gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gYWxsUGFyZW50c0xvb2t1cCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRQYXJlbnRzTG9va3VwW2tleV0pIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgYWxsUGFyZW50c0xvb2t1cFtrZXldO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5DbGVhck5vdE5lZWRlZERhdGEodGVtcCwgYWxsUGFyZW50c0xvb2t1cCwgaGFzTW9yZU1lbWJlcnMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBwcml2YXRlIENsZWFyTm90TmVlZGVkRGF0YShsYXN0TGV2ZWxOb2RlczogSU1lbWJlck5vZGVbXSwgYWxsUGFyZW50c0xvb2t1cDogSU1lbWJlck5vZGVMb29rdXAsIGhhc01vcmVNZW1iZXJzOiBib29sZWFuKTogSUZpbHRlckluZm8ge1xyXG4gICAgICAgICAgICBsYXN0TGV2ZWxOb2Rlcy5mb3JFYWNoKHg9PmRlbGV0ZSB4LmRhdGEubGV2ZWwpO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBwYXJlbnRLZXkgaW4gYWxsUGFyZW50c0xvb2t1cCkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIGFsbFBhcmVudHNMb29rdXBbcGFyZW50S2V5XS5kYXRhLmxldmVsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB7IExhc3RMZXZlbE5vZGVzOiBsYXN0TGV2ZWxOb2RlcywgUGFyZW50c0xvb2t1cDogYWxsUGFyZW50c0xvb2t1cCwgSGFzTW9yZU1lbWJlcnM6IGhhc01vcmVNZW1iZXJzIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIFNlYXJjaE1lbWJlcnNDb3JlKGlucHV0OiBJTWVtYmVyTm9kZVtdICx0YXJnZXRMZXZlbE51bWJlcjogbnVtYmVyLGZpbHRlcjogTWVtYmVyRmlsdGVyKTogSU1lbWJlck5vZGVbXSB7XHJcbiAgICAgICAgICAgIGlmICghZmlsdGVyKSByZXR1cm4gaW5wdXQ7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBpbnB1dDtcclxuICAgICAgICAgICAgdmFyIG1hdGNoRm91bmRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB2YXIgbWF0Y2hDb3VudGVyID0gMDtcclxuICAgICAgICAgICAgQ29tYXJjaC5VdGlscy5UcmVlVXRpbHMuVHJlZUhlbHBlcnMuVHJhdmVyc2VMaXN0UHJlb3JkZXI8SU1lbWJlck5vZGU+KHJlc3VsdCxcclxuICAgICAgICAgICAgICAgICh4KSA9PiB4LmNoaWxkcmVuIGFzIElNZW1iZXJOb2RlW10sXHJcbiAgICAgICAgICAgICAgICAoeCwgcGFyZW50LCBsZXZlbCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobGV2ZWwgPT09IHRhcmdldExldmVsTnVtYmVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmlsdGVyLlR5cGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBNZW1iZXJGaWx0ZXJUeXBlLkNvbnRhaW5zOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGb3VuZGVkID0geC50ZXh0LnRvTG93ZXJDYXNlKCkuaW5kZXhPZihmaWx0ZXIuVmFsdWUudG9Mb3dlckNhc2UoKSkgIT09IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgTWVtYmVyRmlsdGVyVHlwZS5CZWdpbnNXaXRoOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGb3VuZGVkID0geC50ZXh0LnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aChmaWx0ZXIuVmFsdWUudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBNZW1iZXJGaWx0ZXJUeXBlLkVuZHNXaXRoOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hGb3VuZGVkID0geC50ZXh0LnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoZmlsdGVyLlZhbHVlLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtYXRjaEZvdW5kZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaENvdW50ZXIrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGlmICghbWF0Y2hDb3VudGVyKSByZXR1cm4gW107XHJcbiAgICAgICAgICAgIENvbWFyY2guVXRpbHMuVHJlZVV0aWxzLlRyZWVIZWxwZXJzLlRyYXZlcnNlTGlzdFByZW9yZGVyPElNZW1iZXJOb2RlPihyZXN1bHQsXHJcbiAgICAgICAgICAgICAgICAoeCkgPT4geC5jaGlsZHJlbiBhcyBJTWVtYmVyTm9kZVtdLFxyXG4gICAgICAgICAgICAgICAgKHgsIHBhcmVudCwgbGV2ZWwsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxldmVsIDwgdGFyZ2V0TGV2ZWxOdW1iZXIgJiYgIXguY2hpbGRyZW4ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHByaXZhdGUgQ3JlYXRlSWRzKGlucHV0OiBJTWVtYmVyTm9kZVtdKSB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBpbnB1dDtcclxuICAgICAgICAgICAgQ29tYXJjaC5VdGlscy5UcmVlVXRpbHMuVHJlZUhlbHBlcnMuVHJhdmVyc2VMaXN0UHJlb3JkZXI8SU1lbWJlck5vZGU+KHJlc3VsdCxcclxuICAgICAgICAgICAgICAgICh4KSA9PiB4LmNoaWxkcmVuIGFzIElNZW1iZXJOb2RlW10sXHJcbiAgICAgICAgICAgICAgICAoeCwgcGFyZW50LCBsZXZlbCwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50UGFydCA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQYXJ0ID0gcGFyZW50LmlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKHBhcmVudFBhcnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGBbJHt4LnRleHR9XWApO1xyXG4gICAgICAgICAgICAgICAgICAgIHhbXCJpZFwiXSA9IHBhcnRzLmpvaW4oXCIuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBBZGRQYXJlbnRVbmlxdWVOYW1lc19MZXZlbHNfQ2hpbGRDb3VudF9BbmRDYWxjdWxhdGVUb3RhbEVsZW1lbnRzQ291bnQoaW5wdXQ6IElNZW1iZXJOb2RlW10pIHtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGlucHV0O1xyXG4gICAgICAgICAgICBDb21hcmNoLlV0aWxzLlRyZWVVdGlscy5UcmVlSGVscGVycy5UcmF2ZXJzZUxpc3RQcmVvcmRlcjxJTWVtYmVyTm9kZT4ocmVzdWx0LFxyXG4gICAgICAgICAgICAgICAgKHgpID0+IHguY2hpbGRyZW4gYXMgSU1lbWJlck5vZGVbXSxcclxuICAgICAgICAgICAgICAgICh4OklNZW1iZXJOb2RlLCBwYXJlbnQsIGxldmVsLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRVbmlxdWVOYW1lID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFVuaXF1ZU5hbWUgPSBwYXJlbnQuaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHguZGF0YSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50VW5pcXVlTmFtZTogcGFyZW50VW5pcXVlTmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWw6IGxldmVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlblRvdGFsQ291bnQ6eC5jaGlsZHJlbi5sZW5ndGhcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG90YWxFbGVtZW50c0NvdW50Kys7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbmV3IENvbWFyY2guVXRpbHMuVHJlZVV0aWxzLkZvcndhcmRUcmVlVHJhdmVyc2FsSXRlcmF0b3JGYWN0b3J5KClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgc3RhdGljIENyZWF0ZUZha2VUaW1lSGllcmFyY2h5KG51bWJlck9mWWVhcnM6IG51bWJlcik6SU1lbWJlck5vZGVbXSB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQ6SU1lbWJlck5vZGVbXSA9IFtdO1xyXG4gICAgICAgICAgICB2YXIgbW9udGhzID0gW1wiSmFudWFyeVwiLCBcIkZlYnJ1YXJ5XCIsIFwiTWFyY2hcIiwgXCJBcHJpbFwiLCBcIk1heVwiLCBcIkp1bmVcIiwgXCJKdWx5XCIsIFwiQXVndXN0XCIsIFwiU2VwdGVtYmVyXCIsIFwiT2N0b2JlclwiLCBcIk5vdmVtYmVyXCIsXCJEZWNlbWJlclwiXTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgbnVtYmVyT2ZZZWFyczsgeSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgeWVhckl0ZW06IElNZW1iZXJOb2RlID0geyB0ZXh0OiAoMjAwMCArIHkpLnRvU3RyaW5nKCksIGNoaWxkcmVuOiBbXSB9O1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goeWVhckl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgcSA9IDA7IHEgPCA0OyBxKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcXVhdGVySXRlbTogSU1lbWJlck5vZGUgPSB7IHRleHQ6IFwiUVwiICsgKHErMSkudG9TdHJpbmcoKSwgY2hpbGRyZW46IFtdIH07XHJcbiAgICAgICAgICAgICAgICAgICAgeWVhckl0ZW0uY2hpbGRyZW4ucHVzaChxdWF0ZXJJdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtID0gcSozOyBtIDwgcSozKzM7IG0rKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9udGhJdGVtOiBJTWVtYmVyTm9kZSA9IHsgdGV4dDogbW9udGhzW21dLCBjaGlsZHJlbjogW10gfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcXVhdGVySXRlbS5jaGlsZHJlbi5wdXNoKG1vbnRoSXRlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGQgPSAwOyBkIDwgMzA7IGQrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRheUl0ZW06IElNZW1iZXJOb2RlID0geyB0ZXh0OiAoZCsxKS50b1N0cmluZygpLCBjaGlsZHJlbjogW10gfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbnRoSXRlbS5jaGlsZHJlbi5wdXNoKGRheUl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIEhhc01vcmVNZW1iZXJzKGNvdW50OiBudW1iZXIsIGxvYWRlZExhc3RMZXZlbE5vZGVzOklNZW1iZXJOb2RlW10pOiBib29sZWFuIHtcclxuICAgICAgICAgICAgcmV0dXJuIGxvYWRlZExhc3RMZXZlbE5vZGVzLmxlbmd0aCA9PT0gY291bnQrMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxufSJdfQ==