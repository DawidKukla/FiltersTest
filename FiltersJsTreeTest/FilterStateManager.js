var FilterStateManagerModule;
(function (FilterStateManagerModule) {
    var AffectedNodesSet = TestTree.Common.AffectedNodesSet;
    var TreeHelpers = Comarch.Utils.TreeUtils.TreeHelpers;
    var ForwardTreeTraversalIteratorFactory = Comarch.Utils.TreeUtils.ForwardTreeTraversalIteratorFactory;
    let FilterType;
    (function (FilterType) {
        FilterType[FilterType["Included"] = "Included"] = "Included";
        FilterType[FilterType["Excluded"] = "Excluded"] = "Excluded";
    })(FilterType = FilterStateManagerModule.FilterType || (FilterStateManagerModule.FilterType = {}));
    let SelectionMode;
    (function (SelectionMode) {
        SelectionMode[SelectionMode["Selected"] = "Selected"] = "Selected";
        SelectionMode[SelectionMode["Deselected"] = "Deselected"] = "Deselected";
        SelectionMode[SelectionMode["Undetermined"] = "Undetermined"] = "Undetermined";
    })(SelectionMode = FilterStateManagerModule.SelectionMode || (FilterStateManagerModule.SelectionMode = {}));
    class ExtendedFilterItem {
        constructor(uniqueName, parentUniqueName, childrenTotalCount, type, children) {
            this.Children = {};
            this.UniqueName = uniqueName,
                this.ParentUniqueName = parentUniqueName;
            this.Type = type || FilterType.Included;
            this.Children = children || {};
            this.ChildrenTotalCount = childrenTotalCount || 0;
        }
        get Parent() { return this.AllItemsLookup[this.ParentUniqueName]; }
        get CurrentChildrenCount() { return Object.keys(this.Children).length; }
        get IsLeaf() { return this.CurrentChildrenCount === 0; }
        AddChild(child, isSelected) {
            this.InheritType(child);
            child.AllItemsLookup = this.AllItemsLookup;
            child.RegisterInParent(isSelected);
        }
        InheritType(child) {
            child.Type = this.Type;
        }
        RegisterInParent(isSelected) {
            switch (this.Parent.Type) {
                case FilterType.Included:
                    if (isSelected) {
                        this.Parent.Children[this.UniqueName] = this;
                        this.AllItemsLookup[this.UniqueName] = this;
                    }
                    else {
                        delete this.Parent.Children[this.UniqueName];
                        delete this.AllItemsLookup[this.UniqueName];
                    }
                    break;
                case FilterType.Excluded:
                    if (isSelected) {
                        delete this.Parent.Children[this.UniqueName];
                        delete this.AllItemsLookup[this.UniqueName];
                    }
                    else {
                        this.Parent.Children[this.UniqueName] = this;
                        this.AllItemsLookup[this.UniqueName] = this;
                    }
                    break;
            }
        }
        HandleSelectionChange(isSelected, isTargetNode, affectedNodesSet) {
            if (isTargetNode) {
                this.Type = isSelected ? FilterType.Excluded : FilterType.Included;
            }
            affectedNodesSet.Add(this.UniqueName);
            this.RemoveAllChildren();
            if (!this.Parent)
                return;
            this.RegisterInParent(isSelected);
            this.TryRefreshUp(affectedNodesSet);
        }
        TryRefreshUp(affectedNodesSet) {
            if (!this.Parent)
                return;
            var mode = this.Parent.GetSelectionMode();
            if (mode === SelectionMode.Undetermined) {
                this.AffectAllParents(affectedNodesSet);
            }
            else {
                this.Parent.HandleSelectionChange(mode === SelectionMode.Selected, true, affectedNodesSet);
            }
        }
        GetSelectionMode() {
            const allChildrenAreLeafs = this.CheckAllChidrenAreLeafs();
            if (this.ChildrenTotalCount === this.CurrentChildrenCount && allChildrenAreLeafs) {
                return this.Type === FilterType.Included ? SelectionMode.Selected : SelectionMode.Deselected;
            }
            else if (this.CurrentChildrenCount === 0) {
                return this.Type === FilterType.Excluded ? SelectionMode.Selected : SelectionMode.Deselected;
            }
            return SelectionMode.Undetermined;
        }
        AffectAllParents(affectedNodesSet) {
            affectedNodesSet.Add(this.UniqueName);
            if (!this.Parent)
                return;
            this.Parent.AffectAllParents(affectedNodesSet);
        }
        CheckAllChidrenAreLeafs() {
            let result = true;
            const filterItemLookup = this.Children;
            for (let childKey in filterItemLookup) {
                if (filterItemLookup.hasOwnProperty(childKey)) {
                    const child = filterItemLookup[childKey];
                    if (!child.IsLeaf) {
                        result = false;
                        break;
                    }
                }
            }
            return result;
        }
        RemoveAllChildren() {
            const keys = Object.keys(this.Children);
            for (let i = keys.length - 1; i >= 0; i--) {
                const child = this.Children[keys[i]];
                child.RemoveAllChildren();
                delete this.AllItemsLookup[child.UniqueName];
                delete this.Children[child.UniqueName];
            }
        }
        GetSelectionStatus(childUniqueName) {
            const child = this.Children[childUniqueName];
            if (child && child.CurrentChildrenCount > 0) {
                return SelectionMode.Undetermined;
            }
            switch (this.Type) {
                case FilterType.Included:
                    return child ? SelectionMode.Selected : SelectionMode.Deselected;
                case FilterType.Excluded:
                    return child ? SelectionMode.Deselected : SelectionMode.Selected;
                default:
                    return SelectionMode.Undetermined;
            }
        }
    }
    FilterStateManagerModule.ExtendedFilterItem = ExtendedFilterItem;
    class FilterStateManager {
        constructor(childrenTotalCount) {
            this._root = this.GetEmptyRootItem();
            this._root.ChildrenTotalCount = childrenTotalCount;
            this._root.AllItemsLookup = {};
            this._root.AllItemsLookup[this._root.UniqueName] = this._root;
        }
        GetEmptyRootItem() {
            return new ExtendedFilterItem("#", null, FilterType.Excluded);
        }
        AddNodes(sortedParents, targetNode, isSelected) {
            var affectedNodes = new AffectedNodesSet();
            sortedParents.forEach(node => this.AddNode(node, isSelected, false, affectedNodes));
            this.AddNode(targetNode, isSelected, true, affectedNodes);
            return affectedNodes;
        }
        AddNode(node, isSelected, isTargetNode, affectedNodesSet) {
            const existingNode = this._root.AllItemsLookup[node.UniqueName];
            const existingParentNode = this._root.AllItemsLookup[node.ParentUniqueName];
            if (!existingNode) {
                if (existingParentNode) {
                    existingParentNode.AddChild(node, isSelected);
                    if (isTargetNode) {
                        node.HandleSelectionChange(isSelected, isTargetNode, affectedNodesSet);
                    }
                }
                else {
                    throw new Error("Can not add node to not existing parent.");
                }
                return false;
            }
            else {
                if (isTargetNode) {
                    existingNode.HandleSelectionChange(isSelected, true, affectedNodesSet);
                }
            }
            return true;
        }
        ClearState(isSelect) {
            this._root.RemoveAllChildren();
            this._root.Type = isSelect ? FilterType.Excluded : FilterType.Included;
            return AffectedNodesSet.Empty.Add("#");
        }
        GetState() { return this._root; }
        Serialize(includeChildrenTotalCount = true) {
            const result = TreeHelpers.Convert(this._root, x => Object.keys(x.Children).map(key => x.Children[key]), x => x.Children, (current) => {
                const result = { Type: current.Type, UniqueName: current.UniqueName, Children: [] };
                if (includeChildrenTotalCount) {
                    result.ChildrenTotalCount = current.ChildrenTotalCount;
                }
                return result;
            });
            return result;
        }
        Deserialize(serializedRoot) {
            var lookup = {};
            this._root = TreeHelpers.Convert(serializedRoot, x => x.Children, x => null, (current, parent) => {
                var parentUniqueName = null;
                if (parent) {
                    parentUniqueName = parent.UniqueName;
                }
                const result = new ExtendedFilterItem(current.UniqueName, parentUniqueName, current.ChildrenTotalCount, current.Type);
                result.AllItemsLookup = lookup;
                lookup[result.UniqueName] = result;
                return result;
            }, (parent, child) => parent.Children[child.UniqueName] = child);
        }
        GetSelectionStatus(parentIds, id) {
            let status = SelectionMode.Undetermined;
            let currentParent;
            let currentChildUniqueName = id;
            for (let index = 0; index < parentIds.length; index++) {
                const currentParentUniqueName = parentIds[index];
                currentParent = this._root.AllItemsLookup[currentParentUniqueName];
                if (currentParent) {
                    status = currentParent.GetSelectionStatus(currentChildUniqueName);
                    break;
                }
                else {
                    currentChildUniqueName = currentParentUniqueName;
                }
            }
            return status;
        }
        GetAllNodeSelectionStatus() {
            return this._root.GetSelectionMode();
        }
        GetLeafs() {
            var result = [];
            TreeHelpers.TraversePreorder(this._root, x => Object.keys(x.Children).map(key => x.Children[key]), (current) => {
                if (current.IsLeaf) {
                    result.push(current.UniqueName);
                }
                return true;
            }, new ForwardTreeTraversalIteratorFactory());
            return result;
        }
        PerformCleanup(cleanedLeafs) {
            var affectedNodesSet = AffectedNodesSet.Empty;
            var cleanedLeafsLookup = {};
            cleanedLeafs.forEach(x => cleanedLeafsLookup[x] = true);
            var currentLeafs = [];
            Object.keys(this._root.AllItemsLookup).forEach(key => {
                let filterItem = this._root.AllItemsLookup[key];
                if (filterItem.IsLeaf) {
                    currentLeafs.push(filterItem);
                }
            });
            currentLeafs.forEach(currentLeaf => {
                if (!cleanedLeafsLookup[currentLeaf.UniqueName]) {
                    currentLeaf.HandleSelectionChange(false, true, affectedNodesSet);
                }
            });
            this.Print();
        }
        Print() {
            console.log(this._root.AllItemsLookup);
            var text = "";
            var writeLevelIndent = (text, level) => {
                for (let i = 0; i < level; i++) {
                    text = text + "| ";
                }
                return text;
            };
            TreeHelpers.TraversePreorder(this._root, x => Object.keys(x.Children).map(key => x.Children[key]), (current, parent, level) => {
                text = writeLevelIndent(text, level);
                text += "|";
                text += "-";
                text += this.PrintFilterItem(current);
                text += "\n";
                return true;
            }, new ForwardTreeTraversalIteratorFactory());
            console.log(text);
        }
        PrintFilterItem(filterItem) {
            let type = "";
            switch (filterItem.Type) {
                case FilterType.Included:
                    type = type + "(I)";
                    break;
                case FilterType.Excluded:
                    type = type + "(E)";
                    break;
                default:
            }
            return filterItem.UniqueName + type;
        }
    }
    FilterStateManagerModule.FilterStateManager = FilterStateManager;
})(FilterStateManagerModule || (FilterStateManagerModule = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRmlsdGVyU3RhdGVNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRmlsdGVyU3RhdGVNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQVUsd0JBQXdCLENBa1ZqQztBQWxWRCxXQUFVLHdCQUF3QjtJQUM5QixJQUFPLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7SUFDM0QsSUFBTyxXQUFXLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO0lBQ3pELElBQU8sbUNBQW1DLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsbUNBQW1DLENBQUM7SUFTekcsSUFBWSxVQUdYO0lBSEQsV0FBWSxVQUFVO1FBQ2xCLG9DQUFTLFVBQWlCLGNBQUEsQ0FBQTtRQUMxQixvQ0FBUyxVQUFpQixjQUFBLENBQUE7SUFDOUIsQ0FBQyxFQUhXLFVBQVUsR0FBVixtQ0FBVSxLQUFWLG1DQUFVLFFBR3JCO0lBRUQsSUFBWSxhQUlYO0lBSkQsV0FBWSxhQUFhO1FBQ3JCLDBDQUFTLFVBQWlCLGNBQUEsQ0FBQTtRQUMxQiw0Q0FBVyxZQUFtQixnQkFBQSxDQUFBO1FBQzlCLDhDQUFhLGNBQXFCLGtCQUFBLENBQUE7SUFDdEMsQ0FBQyxFQUpXLGFBQWEsR0FBYixzQ0FBYSxLQUFiLHNDQUFhLFFBSXhCO0lBTUQ7UUFZSSxZQUFZLFVBQWtCLEVBQUUsZ0JBQXdCLEVBQUUsa0JBQTBCLEVBQUUsSUFBaUIsRUFBRSxRQUE0QjtZQVBySSxhQUFRLEdBQXNCLEVBQUUsQ0FBQztZQVE3QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVU7Z0JBQ3hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztZQUM3QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxJQUFJ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QUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3ZCLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3JDLElBQUksSUFBSSxHQUFHLENBQUM7Z0JBQ1osSUFBSSxJQUFJLEdBQUcsQ0FBQztnQkFDWixJQUFJLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDdEMsSUFBSSxJQUFJLElBQUksQ0FBQztnQkFDYixNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2hCLENBQUMsRUFDRCxJQUFJLG1DQUFtQyxFQUFzQixDQUNoRSxDQUFDO1lBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QixDQUFDO1FBRUQsZUFBZSxDQUFDLFVBQThCO1lBQzFDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNkLE1BQU0sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixLQUFLLFVBQVUsQ0FBQyxRQUFRO29CQUNwQixJQUFJLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQztvQkFDcEIsS0FBSyxDQUFDO2dCQUNWLEtBQUssVUFBVSxDQUFDLFFBQVE7b0JBQ3BCLElBQUksR0FBRyxJQUFJLEdBQUcsS0FBSyxDQUFDO29CQUNwQixLQUFLLENBQUM7Z0JBQ1YsUUFBUTtZQUNSLENBQUM7WUFDRCxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDeEMsQ0FBQztLQUdKO0lBbExZLDJDQUFrQixxQkFrTDlCLENBQUE7QUFDTCxDQUFDLEVBbFZTLHdCQUF3QixLQUF4Qix3QkFBd0IsUUFrVmpDIiwic291cmNlc0NvbnRlbnQiOlsibmFtZXNwYWNlIEZpbHRlclN0YXRlTWFuYWdlck1vZHVsZSB7XHJcbiAgICBpbXBvcnQgQWZmZWN0ZWROb2Rlc1NldCA9IFRlc3RUcmVlLkNvbW1vbi5BZmZlY3RlZE5vZGVzU2V0O1xyXG4gICAgaW1wb3J0IFRyZWVIZWxwZXJzID0gQ29tYXJjaC5VdGlscy5UcmVlVXRpbHMuVHJlZUhlbHBlcnM7XHJcbiAgICBpbXBvcnQgRm9yd2FyZFRyZWVUcmF2ZXJzYWxJdGVyYXRvckZhY3RvcnkgPSBDb21hcmNoLlV0aWxzLlRyZWVVdGlscy5Gb3J3YXJkVHJlZVRyYXZlcnNhbEl0ZXJhdG9yRmFjdG9yeTtcclxuXHJcbiAgICBleHBvcnQgaW50ZXJmYWNlIElGaWx0ZXJJdGVtIHtcclxuICAgICAgICBUeXBlOiBGaWx0ZXJUeXBlO1xyXG4gICAgICAgIFVuaXF1ZU5hbWU6IHN0cmluZztcclxuICAgICAgICBDaGlsZHJlblRvdGFsQ291bnQ/OiBudW1iZXI7XHJcbiAgICAgICAgQ2hpbGRyZW46IElGaWx0ZXJJdGVtW107XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGVudW0gRmlsdGVyVHlwZSB7XHJcbiAgICAgICAgSW5jbHVkZWQ9XCJJbmNsdWRlZFwiIGFzIGFueSxcclxuICAgICAgICBFeGNsdWRlZD1cIkV4Y2x1ZGVkXCIgYXMgYW55XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGVudW0gU2VsZWN0aW9uTW9kZSB7XHJcbiAgICAgICAgU2VsZWN0ZWQ9XCJTZWxlY3RlZFwiIGFzIGFueSxcclxuICAgICAgICBEZXNlbGVjdGVkPVwiRGVzZWxlY3RlZFwiIGFzIGFueSxcclxuICAgICAgICBVbmRldGVybWluZWQ9XCJVbmRldGVybWluZWRcIiBhcyBhbnlcclxuICAgIH1cclxuICAgIFxyXG4gICAgZXhwb3J0IGludGVyZmFjZSBJRmlsdGVySXRlbUxvb2t1cCAge1xyXG4gICAgICAgIFtrZXk6IHN0cmluZ106IEV4dGVuZGVkRmlsdGVySXRlbVxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBleHBvcnQgY2xhc3MgRXh0ZW5kZWRGaWx0ZXJJdGVtIHtcclxuICAgICAgICBBbGxJdGVtc0xvb2t1cDogSUZpbHRlckl0ZW1Mb29rdXA7XHJcbiAgICAgICAgUGFyZW50VW5pcXVlTmFtZTogc3RyaW5nO1xyXG4gICAgICAgIFVuaXF1ZU5hbWU6IHN0cmluZztcclxuICAgICAgICBUeXBlOiBGaWx0ZXJUeXBlO1xyXG4gICAgICAgIENoaWxkcmVuOiBJRmlsdGVySXRlbUxvb2t1cCA9IHt9O1xyXG4gICAgICAgIENoaWxkcmVuVG90YWxDb3VudDogbnVtYmVyO1xyXG5cclxuICAgICAgICBnZXQgUGFyZW50KCk6IEV4dGVuZGVkRmlsdGVySXRlbSB7IHJldHVybiB0aGlzLkFsbEl0ZW1zTG9va3VwW3RoaXMuUGFyZW50VW5pcXVlTmFtZV07IH1cclxuICAgICAgICBnZXQgQ3VycmVudENoaWxkcmVuQ291bnQoKTogbnVtYmVyIHsgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuQ2hpbGRyZW4pLmxlbmd0aDsgfVxyXG4gICAgICAgIGdldCBJc0xlYWYoKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLkN1cnJlbnRDaGlsZHJlbkNvdW50ID09PSAwOyB9XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHVuaXF1ZU5hbWU6IHN0cmluZywgcGFyZW50VW5pcXVlTmFtZTogc3RyaW5nLCBjaGlsZHJlblRvdGFsQ291bnQ6IG51bWJlciwgdHlwZT86IEZpbHRlclR5cGUsIGNoaWxkcmVuPzogSUZpbHRlckl0ZW1Mb29rdXApIHtcclxuICAgICAgICAgICAgdGhpcy5VbmlxdWVOYW1lID0gdW5pcXVlTmFtZSxcclxuICAgICAgICAgICAgICAgIHRoaXMuUGFyZW50VW5pcXVlTmFtZSA9IHBhcmVudFVuaXF1ZU5hbWU7XHJcbiAgICAgICAgICAgIHRoaXMuVHlwZSA9IHR5cGUgfHwgRmlsdGVyVHlwZS5JbmNsdWRlZDtcclxuICAgICAgICAgICAgdGhpcy5DaGlsZHJlbiA9IGNoaWxkcmVuIHx8IHt9O1xyXG4gICAgICAgICAgICB0aGlzLkNoaWxkcmVuVG90YWxDb3VudCA9IGNoaWxkcmVuVG90YWxDb3VudCB8fCAwO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgQWRkQ2hpbGQoY2hpbGQ6IEV4dGVuZGVkRmlsdGVySXRlbSwgaXNTZWxlY3RlZDogYm9vbGVhbikge1xyXG4gICAgICAgICAgICB0aGlzLkluaGVyaXRUeXBlKGNoaWxkKTtcclxuICAgICAgICAgICAgY2hpbGQuQWxsSXRlbXNMb29rdXAgPSB0aGlzLkFsbEl0ZW1zTG9va3VwO1xyXG4gICAgICAgICAgICBjaGlsZC5SZWdpc3RlckluUGFyZW50KGlzU2VsZWN0ZWQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBJbmhlcml0VHlwZShjaGlsZDogRXh0ZW5kZWRGaWx0ZXJJdGVtKSB7XHJcbiAgICAgICAgICAgIGNoaWxkLlR5cGUgPSB0aGlzLlR5cGU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgUmVnaXN0ZXJJblBhcmVudChpc1NlbGVjdGVkOiBib29sZWFuKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5QYXJlbnQuVHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIEZpbHRlclR5cGUuSW5jbHVkZWQ6XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuUGFyZW50LkNoaWxkcmVuW3RoaXMuVW5pcXVlTmFtZV0gPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuQWxsSXRlbXNMb29rdXBbdGhpcy5VbmlxdWVOYW1lXSA9IHRoaXM7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLlBhcmVudC5DaGlsZHJlblt0aGlzLlVuaXF1ZU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLkFsbEl0ZW1zTG9va3VwW3RoaXMuVW5pcXVlTmFtZV07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBGaWx0ZXJUeXBlLkV4Y2x1ZGVkOlxyXG4gICAgICAgICAgICAgICAgaWYgKGlzU2VsZWN0ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5QYXJlbnQuQ2hpbGRyZW5bdGhpcy5VbmlxdWVOYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5BbGxJdGVtc0xvb2t1cFt0aGlzLlVuaXF1ZU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLlBhcmVudC5DaGlsZHJlblt0aGlzLlVuaXF1ZU5hbWVdID0gdGhpcztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLkFsbEl0ZW1zTG9va3VwW3RoaXMuVW5pcXVlTmFtZV0gPSB0aGlzO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIEhhbmRsZVNlbGVjdGlvbkNoYW5nZShpc1NlbGVjdGVkOiBib29sZWFuLCBpc1RhcmdldE5vZGU6IGJvb2xlYW4sIGFmZmVjdGVkTm9kZXNTZXQ6IEFmZmVjdGVkTm9kZXNTZXQpIHtcclxuICAgICAgICAgICAgaWYgKGlzVGFyZ2V0Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5UeXBlID0gaXNTZWxlY3RlZCA/IEZpbHRlclR5cGUuRXhjbHVkZWQgOiBGaWx0ZXJUeXBlLkluY2x1ZGVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGFmZmVjdGVkTm9kZXNTZXQuQWRkKHRoaXMuVW5pcXVlTmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuUmVtb3ZlQWxsQ2hpbGRyZW4oKTtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLlBhcmVudCkgcmV0dXJuO1xyXG4gICAgICAgICAgICB0aGlzLlJlZ2lzdGVySW5QYXJlbnQoaXNTZWxlY3RlZCk7XHJcbiAgICAgICAgICAgIHRoaXMuVHJ5UmVmcmVzaFVwKGFmZmVjdGVkTm9kZXNTZXQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgVHJ5UmVmcmVzaFVwKGFmZmVjdGVkTm9kZXNTZXQ6IEFmZmVjdGVkTm9kZXNTZXQpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLlBhcmVudCkgcmV0dXJuO1xyXG4gICAgICAgICAgICB2YXIgbW9kZSA9IHRoaXMuUGFyZW50LkdldFNlbGVjdGlvbk1vZGUoKTtcclxuICAgICAgICAgICAgaWYgKG1vZGUgPT09IFNlbGVjdGlvbk1vZGUuVW5kZXRlcm1pbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLkFmZmVjdEFsbFBhcmVudHMoYWZmZWN0ZWROb2Rlc1NldCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLlBhcmVudC5IYW5kbGVTZWxlY3Rpb25DaGFuZ2UobW9kZT09PVNlbGVjdGlvbk1vZGUuU2VsZWN0ZWQsIHRydWUsIGFmZmVjdGVkTm9kZXNTZXQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgR2V0U2VsZWN0aW9uTW9kZSgpOiBTZWxlY3Rpb25Nb2RlIHtcclxuICAgICAgICAgICAgY29uc3QgYWxsQ2hpbGRyZW5BcmVMZWFmcyA9IHRoaXMuQ2hlY2tBbGxDaGlkcmVuQXJlTGVhZnMoKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuQ2hpbGRyZW5Ub3RhbENvdW50ID09PSB0aGlzLkN1cnJlbnRDaGlsZHJlbkNvdW50ICYmIGFsbENoaWxkcmVuQXJlTGVhZnMpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlR5cGUgPT09IEZpbHRlclR5cGUuSW5jbHVkZWQgPyBTZWxlY3Rpb25Nb2RlLlNlbGVjdGVkIDogU2VsZWN0aW9uTW9kZS5EZXNlbGVjdGVkO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuQ3VycmVudENoaWxkcmVuQ291bnQgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLlR5cGUgPT09IEZpbHRlclR5cGUuRXhjbHVkZWQgPyBTZWxlY3Rpb25Nb2RlLlNlbGVjdGVkIDogU2VsZWN0aW9uTW9kZS5EZXNlbGVjdGVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBTZWxlY3Rpb25Nb2RlLlVuZGV0ZXJtaW5lZDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHByaXZhdGUgQWZmZWN0QWxsUGFyZW50cyhhZmZlY3RlZE5vZGVzU2V0OiBBZmZlY3RlZE5vZGVzU2V0KSB7XHJcbiAgICAgICAgICAgIGFmZmVjdGVkTm9kZXNTZXQuQWRkKHRoaXMuVW5pcXVlTmFtZSk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5QYXJlbnQpIHJldHVybjtcclxuICAgICAgICAgICAgdGhpcy5QYXJlbnQuQWZmZWN0QWxsUGFyZW50cyhhZmZlY3RlZE5vZGVzU2V0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyBDaGVja0FsbENoaWRyZW5BcmVMZWFmcygpOiBib29sZWFuIHtcclxuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRydWU7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbHRlckl0ZW1Mb29rdXAgPSB0aGlzLkNoaWxkcmVuO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBjaGlsZEtleSBpbiBmaWx0ZXJJdGVtTG9va3VwKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVySXRlbUxvb2t1cC5oYXNPd25Qcm9wZXJ0eShjaGlsZEtleSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZCA9IGZpbHRlckl0ZW1Mb29rdXBbY2hpbGRLZXldO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghY2hpbGQuSXNMZWFmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIFJlbW92ZUFsbENoaWxkcmVuKCkge1xyXG4gICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXModGhpcy5DaGlsZHJlbik7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjaGlsZCA9IHRoaXMuQ2hpbGRyZW5ba2V5c1tpXV07XHJcbiAgICAgICAgICAgICAgICBjaGlsZC5SZW1vdmVBbGxDaGlsZHJlbigpO1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuQWxsSXRlbXNMb29rdXBbY2hpbGQuVW5pcXVlTmFtZV07XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5DaGlsZHJlbltjaGlsZC5VbmlxdWVOYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgR2V0U2VsZWN0aW9uU3RhdHVzKGNoaWxkVW5pcXVlTmFtZTogc3RyaW5nKTogU2VsZWN0aW9uTW9kZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5DaGlsZHJlbltjaGlsZFVuaXF1ZU5hbWVdO1xyXG4gICAgICAgICAgICBpZiAoY2hpbGQgJiYgY2hpbGQuQ3VycmVudENoaWxkcmVuQ291bnQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gU2VsZWN0aW9uTW9kZS5VbmRldGVybWluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3dpdGNoICh0aGlzLlR5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBGaWx0ZXJUeXBlLkluY2x1ZGVkOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkID8gU2VsZWN0aW9uTW9kZS5TZWxlY3RlZCA6IFNlbGVjdGlvbk1vZGUuRGVzZWxlY3RlZDtcclxuICAgICAgICAgICAgY2FzZSBGaWx0ZXJUeXBlLkV4Y2x1ZGVkOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkID8gU2VsZWN0aW9uTW9kZS5EZXNlbGVjdGVkIDogU2VsZWN0aW9uTW9kZS5TZWxlY3RlZDtcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiBTZWxlY3Rpb25Nb2RlLlVuZGV0ZXJtaW5lZDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIEZpbHRlclN0YXRlTWFuYWdlciB7XHJcbiAgICAgICAgcHJpdmF0ZSBfcm9vdDogRXh0ZW5kZWRGaWx0ZXJJdGVtO1xyXG5cclxuICAgICAgICBjb25zdHJ1Y3RvcihjaGlsZHJlblRvdGFsQ291bnQ6IG51bWJlcikge1xyXG4gICAgICAgICAgICB0aGlzLl9yb290ID0gdGhpcy5HZXRFbXB0eVJvb3RJdGVtKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX3Jvb3QuQ2hpbGRyZW5Ub3RhbENvdW50ID0gY2hpbGRyZW5Ub3RhbENvdW50O1xyXG4gICAgICAgICAgICB0aGlzLl9yb290LkFsbEl0ZW1zTG9va3VwID0ge307XHJcbiAgICAgICAgICAgIHRoaXMuX3Jvb3QuQWxsSXRlbXNMb29rdXBbdGhpcy5fcm9vdC5VbmlxdWVOYW1lXSA9IHRoaXMuX3Jvb3Q7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgR2V0RW1wdHlSb290SXRlbSgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBFeHRlbmRlZEZpbHRlckl0ZW0oXCIjXCIsIG51bGwsIEZpbHRlclR5cGUuRXhjbHVkZWQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgQWRkTm9kZXMoc29ydGVkUGFyZW50czogRXh0ZW5kZWRGaWx0ZXJJdGVtW10sIHRhcmdldE5vZGU6IEV4dGVuZGVkRmlsdGVySXRlbSwgaXNTZWxlY3RlZDogYm9vbGVhbik6IEFmZmVjdGVkTm9kZXNTZXQge1xyXG4gICAgICAgICAgICB2YXIgYWZmZWN0ZWROb2RlcyA9IG5ldyBBZmZlY3RlZE5vZGVzU2V0KCk7XHJcbiAgICAgICAgICAgIHNvcnRlZFBhcmVudHMuZm9yRWFjaChub2RlID0+IHRoaXMuQWRkTm9kZShub2RlLCBpc1NlbGVjdGVkLCBmYWxzZSwgYWZmZWN0ZWROb2RlcykpO1xyXG4gICAgICAgICAgICB0aGlzLkFkZE5vZGUodGFyZ2V0Tm9kZSwgaXNTZWxlY3RlZCwgdHJ1ZSwgYWZmZWN0ZWROb2Rlcyk7XHJcbiAgICAgICAgICAgIHJldHVybiBhZmZlY3RlZE5vZGVzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHJpdmF0ZSBBZGROb2RlKG5vZGU6IEV4dGVuZGVkRmlsdGVySXRlbSwgaXNTZWxlY3RlZDogYm9vbGVhbiwgaXNUYXJnZXROb2RlOiBib29sZWFuLCBhZmZlY3RlZE5vZGVzU2V0OiBBZmZlY3RlZE5vZGVzU2V0KTogYm9vbGVhbiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nTm9kZTogRXh0ZW5kZWRGaWx0ZXJJdGVtID0gdGhpcy5fcm9vdC5BbGxJdGVtc0xvb2t1cFtub2RlLlVuaXF1ZU5hbWVdO1xyXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ1BhcmVudE5vZGU6IEV4dGVuZGVkRmlsdGVySXRlbSA9IHRoaXMuX3Jvb3QuQWxsSXRlbXNMb29rdXBbbm9kZS5QYXJlbnRVbmlxdWVOYW1lXTtcclxuICAgICAgICAgICAgaWYgKCFleGlzdGluZ05vZGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1BhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudE5vZGUuQWRkQ2hpbGQobm9kZSwgaXNTZWxlY3RlZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVGFyZ2V0Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RlLkhhbmRsZVNlbGVjdGlvbkNoYW5nZShpc1NlbGVjdGVkLCBpc1RhcmdldE5vZGUsIGFmZmVjdGVkTm9kZXNTZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuIG5vdCBhZGQgbm9kZSB0byBub3QgZXhpc3RpbmcgcGFyZW50LlwiKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChpc1RhcmdldE5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBleGlzdGluZ05vZGUuSGFuZGxlU2VsZWN0aW9uQ2hhbmdlKGlzU2VsZWN0ZWQsIHRydWUsIGFmZmVjdGVkTm9kZXNTZXQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIENsZWFyU3RhdGUoaXNTZWxlY3Q6IGJvb2xlYW4pIHtcclxuICAgICAgICAgICAgdGhpcy5fcm9vdC5SZW1vdmVBbGxDaGlsZHJlbigpO1xyXG4gICAgICAgICAgICB0aGlzLl9yb290LlR5cGUgPSBpc1NlbGVjdCA/IEZpbHRlclR5cGUuRXhjbHVkZWQgOiBGaWx0ZXJUeXBlLkluY2x1ZGVkO1xyXG4gICAgICAgICAgICByZXR1cm4gQWZmZWN0ZWROb2Rlc1NldC5FbXB0eS5BZGQoXCIjXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgR2V0U3RhdGUoKSB7IHJldHVybiB0aGlzLl9yb290OyB9XHJcblxyXG4gICAgICAgIFNlcmlhbGl6ZShpbmNsdWRlQ2hpbGRyZW5Ub3RhbENvdW50PXRydWUpOiBJRmlsdGVySXRlbSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFRyZWVIZWxwZXJzLkNvbnZlcnQ8RXh0ZW5kZWRGaWx0ZXJJdGVtLCBJRmlsdGVySXRlbT4odGhpcy5fcm9vdCxcclxuICAgICAgICAgICAgICAgIHggPT4gT2JqZWN0LmtleXMoeC5DaGlsZHJlbikubWFwKGtleSA9PiB4LkNoaWxkcmVuW2tleV0pLFxyXG4gICAgICAgICAgICAgICAgeCA9PiB4LkNoaWxkcmVuLFxyXG4gICAgICAgICAgICAgICAgKGN1cnJlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSB7IFR5cGU6IGN1cnJlbnQuVHlwZSwgVW5pcXVlTmFtZTogY3VycmVudC5VbmlxdWVOYW1lLCBDaGlsZHJlbjogW10gfSBhcyBJRmlsdGVySXRlbTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZUNoaWxkcmVuVG90YWxDb3VudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuQ2hpbGRyZW5Ub3RhbENvdW50ID0gY3VycmVudC5DaGlsZHJlblRvdGFsQ291bnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIERlc2VyaWFsaXplKHNlcmlhbGl6ZWRSb290OiBJRmlsdGVySXRlbSkge1xyXG4gICAgICAgICAgICB2YXIgbG9va3VwOiBJRmlsdGVySXRlbUxvb2t1cCA9IHt9O1xyXG4gICAgICAgICAgICB0aGlzLl9yb290ID0gVHJlZUhlbHBlcnMuQ29udmVydDxJRmlsdGVySXRlbSwgRXh0ZW5kZWRGaWx0ZXJJdGVtPihzZXJpYWxpemVkUm9vdCxcclxuICAgICAgICAgICAgICAgIHggPT4geC5DaGlsZHJlbixcclxuICAgICAgICAgICAgICAgIHggPT4gbnVsbCxcclxuICAgICAgICAgICAgICAgIChjdXJyZW50LCBwYXJlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VW5pcXVlTmFtZSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRVbmlxdWVOYW1lID0gcGFyZW50LlVuaXF1ZU5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBFeHRlbmRlZEZpbHRlckl0ZW0oY3VycmVudC5VbmlxdWVOYW1lLCBwYXJlbnRVbmlxdWVOYW1lLCBjdXJyZW50LkNoaWxkcmVuVG90YWxDb3VudCwgY3VycmVudC5UeXBlKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQuQWxsSXRlbXNMb29rdXAgPSBsb29rdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9va3VwW3Jlc3VsdC5VbmlxdWVOYW1lXSA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIChwYXJlbnQsIGNoaWxkKSA9PiBwYXJlbnQuQ2hpbGRyZW5bY2hpbGQuVW5pcXVlTmFtZV0gPSBjaGlsZFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgR2V0U2VsZWN0aW9uU3RhdHVzKHBhcmVudElkczogc3RyaW5nW10sIGlkOiBzdHJpbmcpOiBTZWxlY3Rpb25Nb2RlIHtcclxuICAgICAgICAgICAgbGV0IHN0YXR1cyA9IFNlbGVjdGlvbk1vZGUuVW5kZXRlcm1pbmVkO1xyXG4gICAgICAgICAgICBsZXQgY3VycmVudFBhcmVudDogRXh0ZW5kZWRGaWx0ZXJJdGVtO1xyXG4gICAgICAgICAgICBsZXQgY3VycmVudENoaWxkVW5pcXVlTmFtZSA9IGlkO1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGFyZW50SWRzLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFBhcmVudFVuaXF1ZU5hbWUgPSBwYXJlbnRJZHNbaW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgY3VycmVudFBhcmVudCA9IHRoaXMuX3Jvb3QuQWxsSXRlbXNMb29rdXBbY3VycmVudFBhcmVudFVuaXF1ZU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBjdXJyZW50UGFyZW50LkdldFNlbGVjdGlvblN0YXR1cyhjdXJyZW50Q2hpbGRVbmlxdWVOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudENoaWxkVW5pcXVlTmFtZSA9IGN1cnJlbnRQYXJlbnRVbmlxdWVOYW1lO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBzdGF0dXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBHZXRBbGxOb2RlU2VsZWN0aW9uU3RhdHVzKCk6IFNlbGVjdGlvbk1vZGUge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcm9vdC5HZXRTZWxlY3Rpb25Nb2RlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBHZXRMZWFmcygpOiBzdHJpbmdbXSB7XHJcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBbXTtcclxuICAgICAgICAgICAgVHJlZUhlbHBlcnMuVHJhdmVyc2VQcmVvcmRlcjxFeHRlbmRlZEZpbHRlckl0ZW0+KHRoaXMuX3Jvb3QsXHJcbiAgICAgICAgICAgICAgICB4ID0+IE9iamVjdC5rZXlzKHguQ2hpbGRyZW4pLm1hcChrZXkgPT4geC5DaGlsZHJlbltrZXldKSxcclxuICAgICAgICAgICAgICAgIChjdXJyZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuSXNMZWFmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGN1cnJlbnQuVW5pcXVlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIG5ldyBGb3J3YXJkVHJlZVRyYXZlcnNhbEl0ZXJhdG9yRmFjdG9yeTxFeHRlbmRlZEZpbHRlckl0ZW0+KCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgUGVyZm9ybUNsZWFudXAoY2xlYW5lZExlYWZzOiBzdHJpbmdbXSkge1xyXG4gICAgICAgICAgICB2YXIgYWZmZWN0ZWROb2Rlc1NldCA9IEFmZmVjdGVkTm9kZXNTZXQuRW1wdHk7XHJcbiAgICAgICAgICAgIHZhciBjbGVhbmVkTGVhZnNMb29rdXA6IHsgW2tleTogc3RyaW5nXTogYm9vbGVhbiB9ID0ge307XHJcbiAgICAgICAgICAgIGNsZWFuZWRMZWFmcy5mb3JFYWNoKHg9PmNsZWFuZWRMZWFmc0xvb2t1cFt4XT10cnVlKTtcclxuICAgICAgICAgICAgdmFyIGN1cnJlbnRMZWFmcyA9IFtdO1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyh0aGlzLl9yb290LkFsbEl0ZW1zTG9va3VwKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmlsdGVySXRlbSA9IHRoaXMuX3Jvb3QuQWxsSXRlbXNMb29rdXBba2V5XTtcclxuICAgICAgICAgICAgICAgIGlmIChmaWx0ZXJJdGVtLklzTGVhZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMZWFmcy5wdXNoKGZpbHRlckl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGN1cnJlbnRMZWFmcy5mb3JFYWNoKGN1cnJlbnRMZWFmID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghY2xlYW5lZExlYWZzTG9va3VwW2N1cnJlbnRMZWFmLlVuaXF1ZU5hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudExlYWYuSGFuZGxlU2VsZWN0aW9uQ2hhbmdlKGZhbHNlLHRydWUsYWZmZWN0ZWROb2Rlc1NldCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLlByaW50KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBQcmludCgpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5fcm9vdC5BbGxJdGVtc0xvb2t1cCk7XHJcbiAgICAgICAgICAgIHZhciB0ZXh0ID0gXCJcIjtcclxuICAgICAgICAgICAgdmFyIHdyaXRlTGV2ZWxJbmRlbnQgPSAodGV4dDogc3RyaW5nLCBsZXZlbDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxldmVsOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gdGV4dCArIFwifCBcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0O1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBUcmVlSGVscGVycy5UcmF2ZXJzZVByZW9yZGVyPEV4dGVuZGVkRmlsdGVySXRlbT4odGhpcy5fcm9vdCxcclxuICAgICAgICAgICAgICAgIHggPT4gT2JqZWN0LmtleXMoeC5DaGlsZHJlbikubWFwKGtleSA9PiB4LkNoaWxkcmVuW2tleV0pLFxyXG4gICAgICAgICAgICAgICAgKGN1cnJlbnQsIHBhcmVudCwgbGV2ZWwpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gd3JpdGVMZXZlbEluZGVudCh0ZXh0LCBsZXZlbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBcInxcIjtcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IFwiLVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIHRleHQgKz0gdGhpcy5QcmludEZpbHRlckl0ZW0oY3VycmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dCArPSBcIlxcblwiO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIG5ldyBGb3J3YXJkVHJlZVRyYXZlcnNhbEl0ZXJhdG9yRmFjdG9yeTxFeHRlbmRlZEZpbHRlckl0ZW0+KClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2codGV4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBQcmludEZpbHRlckl0ZW0oZmlsdGVySXRlbTogRXh0ZW5kZWRGaWx0ZXJJdGVtKTogc3RyaW5nIHtcclxuICAgICAgICAgICAgbGV0IHR5cGUgPSBcIlwiO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGZpbHRlckl0ZW0uVHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIEZpbHRlclR5cGUuSW5jbHVkZWQ6XHJcbiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZSArIFwiKEkpXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBGaWx0ZXJUeXBlLkV4Y2x1ZGVkOlxyXG4gICAgICAgICAgICAgICAgdHlwZSA9IHR5cGUgKyBcIihFKVwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZpbHRlckl0ZW0uVW5pcXVlTmFtZSArIHR5cGU7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICB9XHJcbn0iXX0=