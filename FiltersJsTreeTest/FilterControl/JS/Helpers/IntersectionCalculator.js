var Comarch;
(function (Comarch) {
    var Controls;
    (function (Controls) {
        var FilterControlModule;
        (function (FilterControlModule) {
            var Helpers;
            (function (Helpers) {
                var FilterType = Controls.FilterControlModule.FilterStateManagerModule.Common.FilterType;
                class IntersectionCalculatorFactory {
                    Create(a, b) { return new IntersectionCalculator(a, b); }
                }
                Helpers.IntersectionCalculatorFactory = IntersectionCalculatorFactory;
                class IntersectionPair {
                    constructor(A, B) {
                        this.A = A;
                        this.B = B;
                    }
                }
                class IntersectionCalculator {
                    constructor(a, b) {
                        this._b = b;
                        this._a = a;
                    }
                    Intersect() {
                        return this.IntersectCore(this._a, this._b);
                    }
                    IntersectCore(a, b) {
                        if (a == null)
                            return null;
                        if (b == null)
                            return null;
                        if (a.UniqueName !== b.UniqueName)
                            return null;
                        if (a.Children.length === 0)
                            return this.CloneFilterItem(b, true);
                        if (b.Children.length === 0)
                            return this.CloneFilterItem(a, true);
                        const pairs = this.IntersectChildren(a, b);
                        if (pairs.length === 0)
                            return null;
                        var children = [];
                        pairs.forEach((pair) => {
                            var child = this.IntersectCore(pair.A, pair.B);
                            if (child != null) {
                                children.push(child);
                            }
                        });
                        if (children.length === 0)
                            return null;
                        var result = this.CloneFilterItem(a, false);
                        children.forEach(child => { result.Children.push(child); });
                        return result;
                    }
                    IntersectChildren(a, b) {
                        var result;
                        var aSet = {};
                        a.Children.forEach(x => aSet[x.UniqueName] = x);
                        var bSet = {};
                        b.Children.forEach(x => bSet[x.UniqueName] = x);
                        if ((a.Type === FilterType.Included && b.Type === FilterType.Included)) {
                            result = Enumerable.from(a.Children).intersect(b.Children, x => x.UniqueName).select(x => new IntersectionPair(aSet[x.UniqueName], bSet[x.UniqueName])).toArray();
                        }
                        else if (a.Type === FilterType.Excluded && b.Type === FilterType.Excluded) {
                            result = Enumerable.from(a.Children).union(b.Children, x => x.UniqueName).select(x => new IntersectionPair(aSet[x.UniqueName], bSet[x.UniqueName])).toArray();
                        }
                        else {
                        }
                        return result;
                    }
                    CloneFilterItem(obj, deep) {
                        var clone = { UniqueName: obj.UniqueName, Type: obj.Type, Children: obj.Children };
                        if (deep) {
                            obj.Children.forEach(child => {
                                clone.Children.push(this.CloneFilterItem(child, deep));
                            });
                        }
                        return clone;
                    }
                }
                Helpers.IntersectionCalculator = IntersectionCalculator;
            })(Helpers = FilterControlModule.Helpers || (FilterControlModule.Helpers = {}));
        })(FilterControlModule = Controls.FilterControlModule || (Controls.FilterControlModule = {}));
    })(Controls = Comarch.Controls || (Comarch.Controls = {}));
})(Comarch || (Comarch = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJzZWN0aW9uQ2FsY3VsYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkludGVyc2VjdGlvbkNhbGN1bGF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBVSxPQUFPLENBOEdoQjtBQTlHRCxXQUFVLE9BQU87SUFBQyxJQUFBLFFBQVEsQ0E4R3pCO0lBOUdpQixXQUFBLFFBQVE7UUFBQyxJQUFBLG1CQUFtQixDQThHN0M7UUE5RzBCLFdBQUEsbUJBQW1CO1lBQUMsSUFBQSxPQUFPLENBOEdyRDtZQTlHOEMsV0FBQSxPQUFPO2dCQUVsRCxJQUFPLFVBQVUsR0FBRyxRQUFRLENBQUMsbUJBQW1CLENBQUMsd0JBQXdCLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztnQkFNNUY7b0JBQ0ksTUFBTSxDQUFDLENBQWMsRUFBRSxDQUFjLElBQTZCLE9BQU8sSUFBSSxzQkFBc0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUMvRztnQkFGYSxxQ0FBNkIsZ0NBRTFDLENBQUE7Z0JBTUQ7b0JBQ0ksWUFBbUIsQ0FBSSxFQUFTLENBQUk7d0JBQWpCLE1BQUMsR0FBRCxDQUFDLENBQUc7d0JBQVMsTUFBQyxHQUFELENBQUMsQ0FBRztvQkFBRyxDQUFDO2lCQUMzQztnQkFNRDtvQkFJSSxZQUFZLENBQWMsRUFBQyxDQUFhO3dCQUNwQyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQzt3QkFDWixJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDaEIsQ0FBQztvQkFFTSxTQUFTO3dCQUNaLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDaEQsQ0FBQztvQkFFTyxhQUFhLENBQUksQ0FBYSxFQUFDLENBQWM7d0JBQ2pELElBQUksQ0FBQyxJQUFJLElBQUk7NEJBQ1QsT0FBTyxJQUFJLENBQUM7d0JBQ2hC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QUFELENBQUMsRUE5R1MsT0FBTyxLQUFQLE9BQU8sUUE4R2hCIiwic291cmNlc0NvbnRlbnQiOlsibmFtZXNwYWNlIENvbWFyY2guQ29udHJvbHMuRmlsdGVyQ29udHJvbE1vZHVsZS5IZWxwZXJzIHtcbiAgICBpbXBvcnQgSUZpbHRlckl0ZW0gPSBGaWx0ZXJDb250cm9sTW9kdWxlLkZpbHRlclN0YXRlTWFuYWdlck1vZHVsZS5Db21tb24uSUZpbHRlckl0ZW07XG4gICAgaW1wb3J0IEZpbHRlclR5cGUgPSBDb250cm9scy5GaWx0ZXJDb250cm9sTW9kdWxlLkZpbHRlclN0YXRlTWFuYWdlck1vZHVsZS5Db21tb24uRmlsdGVyVHlwZTtcblxuICAgIGV4cG9ydCBpbnRlcmZhY2UgSUludGVyc2VjdGlvbkNhbGN1bGF0b3JGYWN0b3J5IHtcbiAgICAgICAgQ3JlYXRlKGE6IElGaWx0ZXJJdGVtLGI6SUZpbHRlckl0ZW0pOklJbnRlcnNlY3Rpb25DYWxjdWxhdG9yO1xuICAgIH1cblxuICAgIGV4cG9ydCAgY2xhc3MgSW50ZXJzZWN0aW9uQ2FsY3VsYXRvckZhY3RvcnkgaW1wbGVtZW50cyBJSW50ZXJzZWN0aW9uQ2FsY3VsYXRvckZhY3Rvcnkge1xuICAgICAgICBDcmVhdGUoYTogSUZpbHRlckl0ZW0sIGI6IElGaWx0ZXJJdGVtKTogSUludGVyc2VjdGlvbkNhbGN1bGF0b3IgeyByZXR1cm4gbmV3IEludGVyc2VjdGlvbkNhbGN1bGF0b3IoYSwgYik7IH1cbiAgICB9XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIElJbnRlcnNlY3Rpb25DYWxjdWxhdG9yIHtcbiAgICAgICAgSW50ZXJzZWN0KCk7XG4gICAgfVxuXG4gICAgY2xhc3MgSW50ZXJzZWN0aW9uUGFpcjxUPiB7XG4gICAgICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBBOiBULCBwdWJsaWMgQjogVCkge31cbiAgICB9XG5cbiAgICBleHBvcnQgaW50ZXJmYWNlIElGaWx0ZXJJdGVtTG9va3VwIHtcbiAgICAgICAgW2tleTpzdHJpbmddOklGaWx0ZXJJdGVtXG4gICAgfVxuXG4gICAgZXhwb3J0IGNsYXNzIEludGVyc2VjdGlvbkNhbGN1bGF0b3IgaW1wbGVtZW50cyBJSW50ZXJzZWN0aW9uQ2FsY3VsYXRvciB7XG4gICAgICAgIHByaXZhdGUgX2I7XG4gICAgICAgIHByaXZhdGUgX2E7XG5cbiAgICAgICAgY29uc3RydWN0b3IoYTogSUZpbHRlckl0ZW0sYjpJRmlsdGVySXRlbSkge1xuICAgICAgICAgICAgdGhpcy5fYiA9IGI7XG4gICAgICAgICAgICB0aGlzLl9hID0gYTtcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBJbnRlcnNlY3QoKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5JbnRlcnNlY3RDb3JlKHRoaXMuX2EsIHRoaXMuX2IpO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJpdmF0ZSBJbnRlcnNlY3RDb3JlPFQ+KGE6SUZpbHRlckl0ZW0sYjogSUZpbHRlckl0ZW0pIDpJRmlsdGVySXRlbSB7XG4gICAgICAgICAgICBpZiAoYSA9PSBudWxsKVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgaWYgKGIgPT0gbnVsbClcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIGlmIChhLlVuaXF1ZU5hbWUgIT09IGIuVW5pcXVlTmFtZSlcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIGlmIChhLkNoaWxkcmVuLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5DbG9uZUZpbHRlckl0ZW0oYiwgdHJ1ZSk7XG4gICAgICAgICAgICBpZiAoYi5DaGlsZHJlbi5sZW5ndGggPT09IDApXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuQ2xvbmVGaWx0ZXJJdGVtKGEsIHRydWUpO1xuICAgICAgICAgICAgY29uc3QgcGFpcnMgPSB0aGlzLkludGVyc2VjdENoaWxkcmVuKGEsIGIpO1xuICAgICAgICAgICAgaWYgKHBhaXJzLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIHZhciBjaGlsZHJlbjogQXJyYXk8SUZpbHRlckl0ZW0+ID0gW107XG4gICAgICAgICAgICBwYWlycy5mb3JFYWNoKChwYWlyKSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5JbnRlcnNlY3RDb3JlPFQ+KHBhaXIuQSwgcGFpci5CKTtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDApXG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5DbG9uZUZpbHRlckl0ZW0oYSwgZmFsc2UpO1xuICAgICAgICAgICAgY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7IHJlc3VsdC5DaGlsZHJlbi5wdXNoKGNoaWxkKSB9KTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cblxuICAgICAgICBwcml2YXRlIEludGVyc2VjdENoaWxkcmVuPFQ+KGE6IElGaWx0ZXJJdGVtLCBiOiBJRmlsdGVySXRlbSk6IEFycmF5PEludGVyc2VjdGlvblBhaXI8SUZpbHRlckl0ZW0+PiB7XG4gICAgICAgICAgICB2YXIgcmVzdWx0OiBJbnRlcnNlY3Rpb25QYWlyPElGaWx0ZXJJdGVtPltdO1xuICAgICAgICAgICAgdmFyIGFTZXQ6IElGaWx0ZXJJdGVtTG9va3VwID0ge307XG4gICAgICAgICAgICBhLkNoaWxkcmVuLmZvckVhY2goeCA9PiBhU2V0W3guVW5pcXVlTmFtZV0gPSB4KTtcbiAgICAgICAgICAgIHZhciBiU2V0OiBJRmlsdGVySXRlbUxvb2t1cCA9IHt9O1xuICAgICAgICAgICAgYi5DaGlsZHJlbi5mb3JFYWNoKHggPT4gYlNldFt4LlVuaXF1ZU5hbWVdID0geCk7XG5cbiAgICAgICAgICAgIGlmICgoYS5UeXBlID09PSBGaWx0ZXJUeXBlLkluY2x1ZGVkICYmIGIuVHlwZSA9PT0gRmlsdGVyVHlwZS5JbmNsdWRlZCkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSAgRW51bWVyYWJsZS5mcm9tKGEuQ2hpbGRyZW4pLmludGVyc2VjdChiLkNoaWxkcmVuLCB4ID0+IHguVW5pcXVlTmFtZSkuc2VsZWN0KHggPT4gbmV3IEludGVyc2VjdGlvblBhaXIoYVNldFt4LlVuaXF1ZU5hbWVdLCBiU2V0W3guVW5pcXVlTmFtZV0pKS50b0FycmF5KCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYoYS5UeXBlID09PSBGaWx0ZXJUeXBlLkV4Y2x1ZGVkICYmIGIuVHlwZSA9PT0gRmlsdGVyVHlwZS5FeGNsdWRlZCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdCA9ICBFbnVtZXJhYmxlLmZyb20oYS5DaGlsZHJlbikudW5pb24oYi5DaGlsZHJlbiwgeCA9PiB4LlVuaXF1ZU5hbWUpLnNlbGVjdCh4ID0+IG5ldyBJbnRlcnNlY3Rpb25QYWlyKGFTZXRbeC5VbmlxdWVOYW1lXSwgYlNldFt4LlVuaXF1ZU5hbWVdKSkudG9BcnJheSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy9pZiAoYS5UeXBlID09PSBGaWx0ZXJUeXBlLkluY2x1ZGVkICYmIGIuVHlwZSA9PT0gRmlsdGVyVHlwZS5FeGNsdWRlZCkge1xuICAgICAgICAgICAgICAgIC8vICAgIGlmIChhLkNoaWxkcmVuLmxlbmd0aCA+PSBiLkNoaWxkcmVuLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIC8vICAgICAgIHJlc3VsdCA9IEVudW1lcmFibGUuZnJvbShhLkNoaWxkcmVuKS5leGNlcHQoYi5DaGlsZHJlbix4PT54LlVuaXF1ZU5hbWUpLnNlbGVjdCh4PT5uZXcgSW50ZXJzZWN0aW9uUGFpcih4LHgpKS50b0FycmF5KCk7XG4gICAgICAgICAgICAgICAgLy8gICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgcmVzdWx0ID0gRW51bWVyYWJsZS5mcm9tKGIuQ2hpbGRyZW4pLmV4Y2VwdChhLkNoaWxkcmVuLHg9PnguVW5pcXVlTmFtZSkuc2VsZWN0KHg9Pm5ldyBJbnRlcnNlY3Rpb25QYWlyKHgseCkpLnRvQXJyYXkoKTtcbiAgICAgICAgICAgICAgICAvLyAgICB9XG4gICAgICAgICAgICAgICAgLy99XG4gICAgICAgICAgICAgICAgLy9pZiAoYS5UeXBlID09PSBGaWx0ZXJUeXBlLkV4Y2x1ZGVkICYmIGIuVHlwZSA9PT0gRmlsdGVyVHlwZS5JbmNsdWRlZCkge1xuICAgICAgICAgICAgICAgIC8vICAgIGlmIChhLkNoaWxkcmVuLmxlbmd0aCA+PSBiLkNoaWxkcmVuLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIC8vICAgICAgICByZXN1bHQgPSBFbnVtZXJhYmxlLmZyb20oYS5DaGlsZHJlbikuZXhjZXB0KGIuQ2hpbGRyZW4seD0+eC5VbmlxdWVOYW1lKS5zZWxlY3QoeD0+bmV3IEludGVyc2VjdGlvblBhaXIoeCx4KSkudG9BcnJheSgpO1xuICAgICAgICAgICAgICAgIC8vICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gICAgICAgIHJlc3VsdCA9IEVudW1lcmFibGUuZnJvbShiLkNoaWxkcmVuKS5leGNlcHQoYS5DaGlsZHJlbix4PT54LlVuaXF1ZU5hbWUpLnNlbGVjdCh4PT5uZXcgSW50ZXJzZWN0aW9uUGFpcih4LHgpKS50b0FycmF5KCk7XG4gICAgICAgICAgICAgICAgLy8gICAgfVxuICAgICAgICAgICAgICAgIC8vfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG5cbiAgICAgICAgcHJpdmF0ZSBDbG9uZUZpbHRlckl0ZW0ob2JqOklGaWx0ZXJJdGVtLGRlZXA6IGJvb2xlYW4pOklGaWx0ZXJJdGVtIHtcbiAgICAgICAgICAgIHZhciBjbG9uZTogSUZpbHRlckl0ZW0gPSB7IFVuaXF1ZU5hbWU6IG9iai5VbmlxdWVOYW1lLCBUeXBlOiBvYmouVHlwZSwgQ2hpbGRyZW46IG9iai5DaGlsZHJlbiB9O1xuICAgICAgICAgICAgaWYgKGRlZXApIHtcbiAgICAgICAgICAgICAgICBvYmouQ2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNsb25lLkNoaWxkcmVuLnB1c2godGhpcy5DbG9uZUZpbHRlckl0ZW0oY2hpbGQsIGRlZXApKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjbG9uZTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgIH1cblxuICAgIFxufSJdfQ==